# LibPageSub

一个简单的 OS 页面替换算法 header-only 实现库，带有基于 [Unicorn Engine](https://www.unicorn-engine.org/) 的真实程序模拟器。

## 功能

- 验证多种缺页替换算法
- 标准 Markdown 输出
- 基于 unicorn 的模拟执行生成实际访存数据


![Flow Chart](flow.svg)

## 编译

主库无需编译。有一个测试程序用于评估，只需使用 CMake 走常规流程即可。 

## 模拟

由于程序访存行为不一，且不同架构的指令对于访存的实现不一致，故不采用任何数学模型进行模拟。

C++ 模拟程序仅实现了自测和完全随机访问的测试。对于严苛的测试，提供了基于 `unicorn` 模拟执行并记录的方式获得数据。

### 程序的编译

最简单的编写测试的真实程序的方法是使用 C 语言并搭配合适的工具链。

由于 unicorn 并不处理系统层，故环境可以视为 bare-metal，对应的，我们需要的就是一份 bare-metal 的工具链。
_或者，如果您不使用任何形式的 libc，那理论上所有工具链都将可用_

**体现在命名上，就是`<arch>-unknown-elf-gcc`**，unknown 指明不针对系统，elf 指明生成 ELF。

要重新编译测试程序，您需要安装所需的工具链。
随后在 `sim/` 下执行 `make.sh` 并传入架构参数`<arch>`和工具链前缀`<prifix>`即可在`sim/<arch>/`下生成所有的模拟使用的 ELF。

### 模拟执行环境

提供了一个简单的 LinkerScript 和 配套的加载执行 Python 脚本（下称：模拟器）。默认内存布局如下：

|Start|Size|Usage|
|:-:|:-:|:-:|
|0|0x1000|Reserved|
|0x1000|0x1000|Arguments String|
|0x2000|-|Loadable|

* 预留空间是为了保护和架构特定用途而存在的，其中的一部分也可用于自定义的桩函数（比如通过 setjmp 到一个地址来触发中断），只要您愿意自己修改模拟器。
* 我们将 Loadable 放得如此低，是出于兼容性的考虑，如 x86 real mode 的寻址，以及大量的嵌入式 SoC 通常在接近 0 地址的位置映射片上 FLASH 或 ROM。

模拟器将解析 ELF 文件并加载 PHDR 中的可加载段 (segment) 到指定 VMA。注意，不是 `section` !

出于简单考虑，我们将在模拟器中预设 `SP` (`RSP`,`MSP`,...) 为 `.stack` 段的结束地址以内。 
注意，必须存在 `.stack` 段且 4k 对齐，否则将没有栈空间可用（没有也能运行，如果您喜欢的话）


**函数返回地址**

- 对于 X86 架构，我们将栈底空出 16 bytes 并预存2 ~ 8个返回地址为 .text 段的结束
- 对于 RISCV 架构，我们将设置 RA 寄存器为 .text 段的结束

函数返回时，根据目标对应调用约定，返回值寄存器将被打印。

此外，为了保证退出时不产生错误，请在 .text 段后留出至少一条指令的空间（但不需要是有效的指令，可以在 ldscript 中写个 padding 段，默认链接脚本已经有了）

### FAQ

#### 编译出来了程序，模拟执行的时候访问了没有映射的内存？

1. 检查您的工具链：如果您使用了 libc，则 libc 应该是裸机下的；一些工具链或者架构默认使用一些寄存器（如 GP/TP 等），您需要修改模拟器以正确设置他们
2. 确保您正确初始化了所有变量：包括 libc （如有，ctors 和 dtors 等）
3. 检查参数传递和导入选项：如果您的程序需要参数，可以使用 `sim.h` 中的宏来快速导入，且在模拟运行时请一定传入参数，否则访问参数区的时候就会出错
4. 检查您的程序逻辑：这是最后一步了，也是很常见的一个问题。良好的编程习惯，Respect!

#### 我想更多自定义，比如 TLB, ICache, DCache 啥的

首先，不同架构，不同实现都肯有不同的行为，没有办法进行一个很精确而完备的模拟。如果您知道某款处理器内部实现的细节 (如 OpenC906)，自然可以自行实现相关的策略并模拟出期望的数据。

#### 我想要模拟一个 Linux 上 / Windows 上的程序，怎么做

本模拟器所基于的 Unicorn Engine 只是做了 CPU 上的模拟，没有涉及上层系统。然而，这仍然是可行的，在于您完全可以使用其他上层框架 (例如 qiling) 处理系统调用。

只要您**正确**处理了系统调用，那么一切都会好起来的 :-)



## 注意事项

- 所有的页视为一致大小，仅处理页号
- 如果存在跨页访问，请在输入数据体现
- 如果存在 Cache，也请在输入数据体现




